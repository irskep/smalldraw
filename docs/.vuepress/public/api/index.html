<!DOCTYPE html><html class="default" lang="en" data-base="./"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@smalldraw/core</title><meta name="description" content="Documentation for @smalldraw/core"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script defer src="assets/main.js"></script><script async src="assets/icons.js" id="tsd-icons-script"></script><script async src="assets/search.js" id="tsd-search-script"></script><script async src="assets/navigation.js" id="tsd-nav-script"></script><script async src="assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="index.html" class="title">@smalldraw/core</a><div id="tsd-toolbar-links"></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><h1>@smalldraw/core</h1></div><div class="tsd-panel tsd-typography"><h1 id="smalldrawcore" class="tsd-anchor-link">@smalldraw/core<a href="#smalldrawcore" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h1>
<p><code>@smalldraw/core</code> provides the data model, action system, undo/redo, and tool runtime that power Smalldraw’s drawing experience. This package is deliberately UI-agnostic: React/Konva integrations live in other packages, while this module focuses on describing shapes, mutating documents, and orchestrating tool behavior.</p>
<h2 id="data-model" class="tsd-anchor-link">Data Model<a href="#data-model" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>Documents are collections of <code>Shape</code> objects indexed by id. Every shape shares the following concepts:</p>
<ul>
<li><strong>Geometry</strong> – A discriminated union covering rectangles, ellipses, regular polygons, arbitrary polygons, pen strokes, paths, and beziers. Geometry describes local-space data only (e.g., pen points relative to the shape’s center).</li>
<li><strong>Transform</strong> – Each shape has a canonical transform with translation (world-space center), rotation, scale, and origin. Canonicalization runs whenever shapes enter the document so tools can assume translations are always centered and origins default to (0,0).</li>
<li><strong>Interactions</strong> – Flags for behaviors such as <code>resizable</code> and <code>rotatable</code>. Tools use these to decide which handles to expose or which adapters to invoke.</li>
<li><strong>Style</strong> – Optional <code>Fill</code>, <code>StrokeStyle</code>, and opacity fields. The model does not dictate rendering; it simply records stylistic intent.</li>
</ul>
<p>Bounds calculations live in <code>model/geometryBounds.ts</code>. They derive axis-aligned bounding boxes from geometry + transform and account for stroke width, so selection handles and hit testing have accurate footprints.</p>
<h2 id="actions-and-undo" class="tsd-anchor-link">Actions and Undo<a href="#actions-and-undo" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>Mutations occur through <code>UndoableAction</code> objects. Key actions include <code>AddShape</code>, <code>DeleteShape</code>, <code>UpdateShapeGeometry</code>, <code>UpdateShapeTransform</code>, and <code>CompositeAction</code>. Actions:</p>
<ul>
<li>Operate on a shared <code>DrawingDocument</code> and record previous state to enable undo/redo.</li>
<li>Canonicalize shapes as needed (e.g., <code>AddShape</code> runs <code>canonicalizeShape</code>, <code>UpdateShapeGeometry</code> re-centers point arrays) so downstream code always interacts with normalized data.</li>
<li>Compose via <code>CompositeAction</code> when multi-shape operations should be undone as a unit.</li>
</ul>
<p><code>UndoManager</code> applies actions to documents, maintains undo/redo stacks, and reports capabilities via <code>canUndo</code>/<code>canRedo</code>.</p>
<h2 id="tool-runtime" class="tsd-anchor-link">Tool Runtime<a href="#tool-runtime" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p><code>ToolRuntimeImpl</code> is the bridge between tools and documents. It provides:</p>
<ul>
<li>Event subscription (<code>pointerDown</code>/<code>Move</code>/<code>Up</code>/<code>Cancel</code> and custom events via <code>emit/onEvent</code>).</li>
<li>Draft shape management for in-progress strokes or rectangles.</li>
<li>Shared tool settings (colors, widths) and per-tool state storage.</li>
<li>Selection helpers (<code>getSelection</code>, <code>setSelection</code>, toggling) shared among tools.</li>
<li>Undo action committing (<code>commit</code>) and id/z-index generation.</li>
</ul>
<p><code>DrawingStore</code> wires runtimes together, keeps a single document/undo manager, tracks active tool handles and hover states, and now exposes live selection-frame bounds for UI consumers.</p>
<h2 id="tools" class="tsd-anchor-link">Tools<a href="#tools" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>Tools are declarative modules implementing <code>ToolDefinition</code>. Core tools include:</p>
<ul>
<li><strong>Pen</strong> – Collects pointer points, writes local-space pen geometry, and marks strokes as resizable. Draft updates and final commits share a helper to ensure consistent canonicalization.</li>
<li><strong>Rectangle</strong> – Drags out center/size data from two points, writes canonical transforms, and flags rectangles as rotatable/resizable.</li>
<li><strong>Selection</strong> – Manages selection state, emits handle metadata/hover events, responds to pointer drags for move/resize/rotate, and broadcasts live selection frames. It drives shape resizing via adapters.</li>
</ul>
<h3 id="pointer-drag-controller" class="tsd-anchor-link">Pointer Drag Controller<a href="#pointer-drag-controller" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p><code>pointerDrag.ts</code> provides <code>createPointerDragHandler</code>, a reusable helper that wires pointerDown/move/up/cancel to tool-specific callbacks. Tools can rely on this controller to maintain drag lifecycles without re-implementing event plumbing, reducing the chance of inconsistent cleanup. Selection currently uses this controller; other tools can adopt it to standardize behavior further.</p>
<h3 id="selection-handles-adapters" class="tsd-anchor-link">Selection Handles &amp; Adapters<a href="#selection-handles-adapters" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>Selection exposes a fixed set of handles (corners + rotate). Hover behavior is resolved per handle with modifier-aware descriptors, keeping UI feedback consistent. During drags, selection:</p>
<ol>
<li>Takes snapshots of each selected shape (transform, geometry, normalized layout).</li>
<li>Delegates resize logic to adapters registered per geometry type (rectangles, ellipses, regular polygons, pen strokes). Each adapter receives the snapshot data, selection-frame scale, and layout offsets, and returns geometry or transform updates to apply.</li>
<li>Falls back to translation-only transforms for shapes without adapters or non-resizable interactions, preserving relative positions.</li>
</ol>
<p>Adapters are easy to extend: define <code>matches</code>, <code>prepare</code> (snapshot), and <code>resize</code>. The tests in <code>resizeAdapters.test.ts</code> ensure the documented geometry types stay in sync with the registry.</p>
<h3 id="selection-frames" class="tsd-anchor-link">Selection Frames<a href="#selection-frames" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3>
<p>The selection tool recomputes bounding boxes during drags and emits <code>selection-frame</code> events through the runtime. The store subscribes to these and exposes a getter so UI layers can render transient frames, snapping guides, or overlays without duplicating math.</p>
<h2 id="canonicalization-and-local-space" class="tsd-anchor-link">Canonicalization and Local Space<a href="#canonicalization-and-local-space" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>All point-based geometries (pen, stroke, polygon, path, bezier) are stored in local space relative to their bounding-box center. When shapes enter the document or update geometry, <code>canonicalizeShape</code> recenters points and updates the transform translation accordingly. This guarantees downstream code (renderers, adapters, bounds) can assume geometry is local and transforms carry the world-space position.</p>
<h2 id="testing-philosophy" class="tsd-anchor-link">Testing Philosophy<a href="#testing-philosophy" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>The core package ships comprehensive tests covering:</p>
<ul>
<li>Geometry actions, ensuring canonicalization and undo/redo behave as expected.</li>
<li>Tool runtimes (pen, rectangle, selection) including drafts, commits, handle hover behavior, selection-frame events, and adapter-driven resize flows.</li>
<li>Store behavior, verifying tool activation, shared settings, selection propagation, handle updates, and selection-frame getters.</li>
<li>Adapter coverage via <code>resizeAdapters.test.ts</code> to prevent regressions when adding new geometry types.</li>
</ul>
<p>This suite minimizes the need to inspect implementation details; if a change alters canonicalization, selection frames, or adapter behavior, tests highlight the deviation immediately.</p>
<h2 id="extending-the-core" class="tsd-anchor-link">Extending the Core<a href="#extending-the-core" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2>
<p>When adding a new geometry or tool:</p>
<ol>
<li>Update <code>model/geometry.ts</code> and implement canonicalization logic if the geometry contains local-space coordinates.</li>
<li>Add a resize adapter (or explicitly opt out) and extend the adapter tests.</li>
<li>Hook the geometry into tools or action creators using the existing Abstract APIs: add shapes via <code>AddShape</code>, adjust geometry via <code>UpdateShapeGeometry</code>, and leverage the pointer drag controller for interactive tools.</li>
<li>Extend bounds/tests if the geometry needs custom padding or selection behavior.</li>
</ol>
<p>By adhering to canonical transforms, adapter contracts, and the pointer drag infrastructure, new components integrate cleanly with selection, undo, and future UI layers without requiring deep knowledge of every file.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#smalldrawcore"><span>@smalldraw/core</span></a><ul><li><a href="#data-model"><span>Data <wbr/>Model</span></a></li><li><a href="#actions-and-undo"><span>Actions and <wbr/>Undo</span></a></li><li><a href="#tool-runtime"><span>Tool <wbr/>Runtime</span></a></li><li><a href="#tools"><span>Tools</span></a></li><li><ul><li><a href="#pointer-drag-controller"><span>Pointer <wbr/>Drag <wbr/>Controller</span></a></li><li><a href="#selection-handles-adapters"><span>Selection <wbr/>Handles &amp; <wbr/>Adapters</span></a></li><li><a href="#selection-frames"><span>Selection <wbr/>Frames</span></a></li></ul></li><li><a href="#canonicalization-and-local-space"><span>Canonicalization and <wbr/>Local <wbr/>Space</span></a></li><li><a href="#testing-philosophy"><span>Testing <wbr/>Philosophy</span></a></li><li><a href="#extending-the-core"><span>Extending the <wbr/>Core</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="modules.html">@smalldraw/core</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
