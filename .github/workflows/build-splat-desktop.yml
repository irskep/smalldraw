name: Build Splat Desktop

on:
  push:
  workflow_dispatch:

concurrency:
  group: splat-desktop-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-macos:
    runs-on: macos-14
    env:
      ELECTROBUN_DEVELOPER_ID: ${{ secrets.ELECTROBUN_DEVELOPER_ID }}
      ELECTROBUN_TEAMID: ${{ secrets.ELECTROBUN_TEAMID }}
      ELECTROBUN_APPLEID: ${{ secrets.ELECTROBUN_APPLEID }}
      ELECTROBUN_APPLEIDPASS: ${{ secrets.ELECTROBUN_APPLEIDPASS }}
      APPLE_DEVELOPER_ID_P12_BASE64: ${{ secrets.APPLE_DEVELOPER_ID_P12_BASE64 }}
      APPLE_DEVELOPER_ID_P12_PASSWORD: ${{ secrets.APPLE_DEVELOPER_ID_P12_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.10"

      - name: Cache Bun install cache
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-install-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-install-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Import Apple Developer ID certificate
        if: ${{ env.APPLE_DEVELOPER_ID_P12_BASE64 != '' && env.APPLE_DEVELOPER_ID_P12_PASSWORD != '' }}
        run: |
          CERT_PATH="$RUNNER_TEMP/developer-id-application.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"

          echo -n "$APPLE_DEVELOPER_ID_P12_BASE64" | base64 -D > "$CERT_PATH"

          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" \
            -P "$APPLE_DEVELOPER_ID_P12_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          security default-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" "$KEYCHAIN_PATH"

      - name: Build desktop package
        working-directory: ./apps/splat-desktop
        run: bun run package

      - name: List desktop build outputs
        run: find apps/splat-desktop/build -maxdepth 3 -mindepth 1 | sort

      - name: List desktop artifacts
        run: find apps/splat-desktop/artifacts -maxdepth 3 -mindepth 1 | sort

      - name: Upload desktop artifacts
        uses: actions/upload-artifact@v4
        with:
          name: splat-desktop-macos-${{ github.sha }}
          path: apps/splat-desktop/artifacts/**
          if-no-files-found: error
